#!/bin/sh
# postinst script for opi-control
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    configure)
		# Fix faulty notification upon upgrade
		if dpkg --compare-versions "$2" lt "1.1.32" ;
		then
			msgs=$(grep -d skip -l "Shutting down" /var/spool/kgp-notify/*)
			for msg in $msgs
			do
				msgid=$(basename $msg)
				kgp-notifier -qa $msgid
			done
		fi
		
		echo "set up sysconfig"
		# setup sysconfig parameters
		# auth parameters
        if ! kgp-sysinfo -c "hostinfo" -k "sysauthkey"
        then
            kgp-sysinfo -c "hostinfo" -k "sysauthkey" -w "/var/opi/etc/syspriv.pem"
        fi

        if ! kgp-sysinfo -c "hostinfo" -k "syspubkey"
        then
            kgp-sysinfo -c "hostinfo" -k "syspubkey" -w "/var/opi/etc/syspub.pem"
        fi
        if ! kgp-sysinfo -c "hostinfo" -k "syscert"
        then
            kgp-sysinfo -c "hostinfo" -k "syscert" -w "/etc/opi/opi.cert"
        fi

        if ! kgp-sysinfo -c "dns" -k "dnsauthkey"
        then
            kgp-sysinfo -c "dns" -k "dnsauthkey" -w "/etc/opi/dnspriv.pem"
        fi

        if ! kgp-sysinfo -c "dns" -k "dnspubkey"
        then
            kgp-sysinfo -c "dns" -k "dnspubkey" -w "/etc/opi/dnspub.pem"
        fi

        # mailparameters
        if ! kgp-sysinfo  -c mail -k vdomains
        then
            kgp-sysinfo -c mail -k vdomains -w "/mail/conf/domains"
        fi
        if ! kgp-sysinfo  -c mail -k vmailbox
        then
            kgp-sysinfo -c mail -k vmailbox -w "/mail/conf/vmailbox"
        fi
        if ! kgp-sysinfo -c mail -k saslpasswd
        then
            kgp-sysinfo -c mail -k saslpasswd -w "/mail/conf/sasl_passwd"
        fi
        if ! kgp-sysinfo -c mail -k oprelayserver
        then
            kgp-sysinfo -c mail -k oprelayserver -w "op-mail.openproducts.com"
        fi
        if ! kgp-sysinfo -c mail -k localmail
        then
            kgp-sysinfo -c mail -k localmail -w  "/mail/conf/localmail"
        fi
        if ! kgp-sysinfo -c mail -k virtualalias
        then
            kgp-sysinfo -c mail -k virtualalias -w "/mail/conf/virtual"
        fi

        # setup parameters
        if ! kgp-sysinfo -c setup -k conntesthost
        then
            kgp-sysinfo -c setup -k conntesthost -w "http://conntest.op-i.me"
        fi

        # filesystem parameters
        if ! kgp-sysinfo -c filesystem -k storagemount
        then
            kgp-sysinfo -c filesystem -k storagemount -w "/var/opi/"
        fi
        if ! kgp-sysinfo -c filesystem -k luksdevice
        then
            kgp-sysinfo -c filesystem -k luksdevice -w "/dev/mapper/opi"
        fi
        if ! kgp-sysinfo -c filesystem -k lvmdevice
        then
            kgp-sysinfo -c filesystem -k lvmdevice -w "/dev/pool/data"
        fi
        if ! kgp-sysinfo -c filesystem -k lvmvg 
        then
            kgp-sysinfo -c filesystem -k lvmvg -w "pool"
        fi
        if ! kgp-sysinfo -c filesystem -k lvmlv 
        then
            kgp-sysinfo -c filesystem -k lvmlv -w "data"
        fi

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
