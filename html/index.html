<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>Setup</title>
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Expires" content="0">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    
	<link rel="stylesheet" href="css/app.css">
	<link rel="stylesheet" href="activetheme/css/app.css">
	<link rel="stylesheet" href="css/init.css">
	<link rel="stylesheet" href="activetheme/css/init.css">
	<link rel="stylesheet" href="css/jquery.qtip.min.css">
	<script src="js/jquery.min.js"></script>
	<script src="js/jquery.qtip.min.js"></script>
	<script src="js/helptexts.js"></script>
	<script src="js/form-validator/jquery.form-validator.min.js"></script>

</head>
<body class="claro" id="theBody">
<div id="nav-buttons" class="">
	<button type="button" class="navbutton" opi-page="5" id="b5" title="">Restore Backup</button>
	<button type="button" class="navbutton" opi-page="6" id="b6" title="">Restore In Progress</button>
	<button type="button" class="navbutton" opi-page="7" id="b7" title="">Add User</button>
	<button type="button" class="navbutton" opi-page="10" id="b10" title="">Unlock</button>
	<button type="button" class="navbutton" opi-page="13" id="b13" title="">Shutdown In Progress</button>
    <button type="button" class="navbutton" opi-page="14" id="b14" title="">Reboot In Progress</button>
    <button type="button" class="navbutton" opi-page="15" id="b15" title="">Post Init</button>
    <button type="button" class="navbutton" opi-page="17" id="b17" title="">Storage Error</button>
    <button type="button" class="navbutton" opi-page="18" id="b18" title="">Device Name</button>
    <button type="button" class="navbutton" opi-page="19" id="b19" title="">Known Unit-id</button>
    <button type="button" class="navbutton" opi-page="20" id="b20" title="">Master pwd / Unlock</button>
    <button type="button" class="navbutton" opi-page="22" id="b20" title="">Select storage device</button>
    <button type="button" class="navbutton" opi-page="99" id="b99" title="">Init in progress</button>
</div>

<nav id="nav-shutdown">
	<div id="shutdown">
		<button type="button" class="shutdown" id="btn-shutdown"><img src='img/shutdown.png' /><span>Shutdown <span class="typename"></span></span></button>
	</div>
</nav>

<div id="spinner-bg" class="hidden">
	<div id="spinner">
		<img src='img/spinner.gif' />
	</div>
</div>

<div id="login-bg">
<section id="login">
	<div id="page_error" class="page hidden">
	<h1>Error - Unable to retrieve status</h1>
	<p>Server replied with an unknown error</p>
	</div>

	<!-- <div id="page_restoreinprogress" class="page hidden"> -->
	<div id="page_restoreinprogress" class="page hidden">
		<h1>Restore in progress</h1>
		<p>Data restore in progress, please wait</p>
		<div id="progressstate">
			<div class="restoreinfo">
				<span id="state-label" class="restore-label">Current operation:</span>
				<div class="text-right restoredata">
					<span id="restorestate" class="pull-right">Initializing restore.</span>
				</div>
			</div>
		</div>
		<div id="progressinfo" class="hidden">
			<div id="progressbar">
				<span id="restoreprogress"></span>
			</div>
			<div class="restoreinfo">
				<span id="file-label" class="restore-label">Current file:</span>
				<div class="text-right restoredata">
					<span id="file" class="pull-right"></span>
				</div>
			</div>
			<div class="restoreinfo">
				<span id="transferred-label" class="restore-label">Transferred:</span>
				<div class="text-right restoredata">
					<span id="transferred" class="pull-right"></span>
				</div>
			</div>
			<div class="restoreinfo">
				<span id="eta-label" class="restore-label">Estimated time left:</span>
				<div class="text-right restoredata">
					<span id="eta" class="pull-right"></span>
				</div>
			</div>
		</div>
	</div>
	
	<div id="page_shutdown" class="page hidden">
		<center><h1>Confirm shutdown</h1></center>
		<p></p>
		<div class="sd-buttons">
			<form>
				<button 
					type="submit" 
					id="sd-btn-shutdown" 
					href="/shutdown"
					name="action"
					value="shutdown"
					class="width_50">
					Shutdown
				</button>
			</form>
			<form>
				<button 
					type="submit" 
					id="sd-btn-reboot" 
					href="/shutdown"
					name="action"
					value="reboot"
					class="width_50 btn-right">
					Reboot
				</button>
			</form>
		</div>
		<div class="sd-buttons">
			<button
				type="cancel"
				id="sd-btn-cancel"
				class="fullwidth">
				Cancel
			</button>
		</div>
	</div>

	<div id="page_sderror" class="page hidden">
		<h1>Error - No storage detected</h1>
		<p>Please insert SD card / hard drive and restart</p>
	</div>

	<div id="page_initprogress" class="page hidden">
		<h1>Initializing ...</h1>
		<p>Please have patience, initializing can take a long time</p>

	</div>
	
	<div id="page_shutdownprogress" class="page hidden">
		<h1>Shutdown in progress</h1>
		<p>Please to not remove power until all LEDs are turned off.</p>
	</div>

	<div id="page_rebootprogress" class="page hidden">
		<h1>Unit reboot in progress</h1>
		<p>System is rebooting, please wait ...</p>
	</div>
<!--




		*************************
		* SELECT DEVICE IS HERE *
		*************************







-->

	<div id="page_storagemethod" class="page hidden">
		<h1>Select storage method</h1>
		<p>Please select how to store data</p>
		<form id="devicemethodform">

			<div id="div_sel_physical">
				<p class="form-group">
				<select id="sel_physical" name="physical">
					<!--option value="none">Local on system partition</option>
					<option value="partition">On a separate partition</option>
					<option value="block" selected="true">Physical disk</option-->
				</select>
				</p>
			</div>
			<div>
				<button
					type="submit"
					id="btnPwd"
					href="/stor_sel">
				Continue
				</button>
			</div>
		</form>
	</div>

	<div id="page_storagepartition" class="page hidden">
		<h1>Select partitions</h1>
		<p>Please select partitions to store data on</p>
		<form id="devicepartitionform">
			<div id="partition_container">
				<p class="form-group">
				<label for="sel_partitions">Select partitions</label>
				<select name="partitions" id="sel_partitions" multiple="multiple"
					data-validation="required">
				</select>
				</p>
			</div>
			<div>
				<p class="form-group">
				<label for="sel_part_logical">Select logical storage model</label>
				<select name="logical" id="sel_part_logical">
				</select>
				</p>
			</div>

			<div>
				<p class="form-group">
				<label for="sel_part_encrypt">Select storage encryption</label>
				<select name="encryption" id="sel_part_encrypt">
				</select>
				</p>
			</div>
			<div>
				<button
					type="submit"
					href="/stor_part">
				Continue
				</button>
			</div>
		</form>
	</div>


	<div id="page_storagedevice" class="page hidden">
		<h1>Select devices</h1>
		<p>Please select devices to store data on</p>
		<form id="devicedisksform">
			<div id="storage_container">
				<p class="form-group">
				<label for="sel_devices">Select storage devices</label>
				<select name="devices" id="sel_devices" multiple="multiple"
					data-validation="required">
				</select>
				</p>
			</div>
			<div>
				<p class="form-group">
				<label for="sel_device_logical">Select logical storage model</label>
				<select name="logical" id="sel_device_logical">
				</select>
				</p>
			</div>

			<div>
				<p class="form-group">
				<label for="sel_device_encrypt">Select storage encryption</label>
				<select name="encryption" id="sel_device_encrypt">
				</select>
				</p>
			</div>
			<div>
				<button
					type="submit"
					href="/stor_dev">
				Continue
				</button>
			</div>
		</form>
	</div>



	<div id="page_password" class="page hidden">
		<h1>Select Master Password</h1>
		<form id="pwdform">
			<div id="div_unit_id" class="hidden">
				<p class="form-group">
				<label for='unit_id'><span class="typename"></span> Activation Code</label>
				<input
					title = "unit_id"
					type ="text"
					id ="unit_id"
					name ="unit_id"
					data-validation=""
					data-validation-regexp= '^[\w\d\-]{36}$'
				/> 
				</p>
			</div>
			<div>					
				<p class="form-group">
				<label for='masterpassword_confirmation'>Password</label>
				<input
					title="Master"
					type="password" 
					name="masterpassword_confirmation"
					data-validation="required" 
					data-validation-strength="1"
				/>
				</p>
			</div>
			<div>	
				<p class="form-group">
				<label for='masterpassword'>Confirm Password</label>
				<input 
					type="password" 
					name="masterpassword"
					data-validation="confirmation"
					data-validation="required"
					data-validation-error-msg="Passwords do not match"
				/>
				</p>
			</div>
			<div>	
				<p class="form-group">
				<label class="inline" for='f_pwdform_save'>Store master password on USB</label>
				<input 
					type="checkbox" 
					name="save"
					id="f_pwdform_save"
				/>
				</p>
			</div>
			<div>
				<button 
					type="submit" 
					id="btnPwd" 
					href="/init">
				Continue
				</button>
			</div>
		</form>
	</div>
	
	
	
	<div id="page_user" class="page hidden">
		<h1>Add First User</h1>
		<form id="userform">
			<div>	
				<p class="form-group">
				<label for='displayname'>Real Name</label>
				<input type="text"
					name="displayname"
					title="Displayname"
					data-validation="required"
					data-validation-error-msg="Missing 'Real name'"
					/>
				</p>
			</div>
			<div>
				<p class="form-group">
				<label for='username'>Username</label>
				<input type="text" 	id="username"
					name="username"
					title="Username"
					data-validation-error-msg="Only lowercase 'a-z' allowed in username"
					data-validation="custom" data-validation-regexp="^([a-z]+)$"
					/>
				</p>
			</div>
			<div>	
				<p class="form-group">
				<label for='password'>Password</label>
				<input type="password"
					title="userpassword"
					name="password_confirmation"
					data-validation="required"
					data-validation-strength="1"
					data-validation-error-msg=" "
					/>
				</p>
			</div>
			<div>	
				<p class="form-group">
				<label for='password'>Confirm Password</label>
				<input type="password"
					name="password"
					data-validation="confirmation"
					data-validation="required"
					data-validation-error-msg="Passwords do not match"
				/>
				</p>
			</div>
			<div>
				<button 
					type="submit" 
					id="btnUser"
					href="/user" >
				Continue</button>
			</div>
		</form>
	</div>
	
	<div id="page_opiname" class="page hidden">
		<h1>Select Device Name</h1>
		<form id="opinameform">
			<div>
				<div id="div-devicename">
					<p class="form-group">
					<label for="opiname">Device name</label>
					<input 
						type="text" 	
						id="opiname"
						name="opiname"
						title="OPI name"
						class="lowercase"
					/>
					<span id="opi_namestate" class="help-block form-nameerror"></span>
					</p>
				</div>
				<input type="hidden" name="domain" id="domaincontainer" value=""/>
				<div id="div-opdomains" class="hidden">
					<p class="form-group">
					<label for="domain">Select domain to use</label>
					<select
						id="select_domain"
						title="Domain name"
						disabled="disabled"
					>
					</select>
					</p>
				</div>
				<div id="div-customdomain">
					<p class="form-group">
						<label for="domain">Enter domain to use (optional)</label>
						<input
							type="text"
							id="customdomain"
							title="Custom Domain"
							class="lowercase"
							helpindex="customdomain"
							data-validation="custom"
							data-validation-regexp= "(^$|(?=^.{4,253}$)(^((?!-)[a-zA-Z0-9-]{0,62}[a-zA-Z0-9]\.)+[a-zA-Z]{2,63}$))"
						/>
					</p>
				</div>
				<div id="div-checkbox-customdomain" class="hidden">
					<p class="form-group">
						<label class="inline" for="checkbox-customdomain">Use custom domain</label>
						<input
							type="checkbox"
							id="checkbox-customdomain"
						/>
					</p>
				</div>
				<div>
					<button 
						type="submit"
						id="btnOpiname"
						href="/opiname"
					>
					Continue</button>
				</div>
			</div>
		</form>
	</div>
	
	<div id="page_unlockpassword" class="page hidden">
		<h1>Enter master password</h1>
		<form id="masterpwdform">
				<div>
					<p class="form-group">
					<label for="password">Password</label>
					<input type="password"
						title="masterpassword"
						name="masterpassword"
						data-validation="required"
					>
					</p>
				</div>
				<div>	
					<p class="form-group">
					<label class="inline"  for='f_mpwd_save'>Store master password on USB</label>
					<input
						id="f_mpwd_save" 
						type="checkbox" 
						name="save"
					/>
					</p>
				</div>
				<div>
					<button 
						type="submit"
						id="btnPwdunlock"
						href="/unlock"
					>
					Continue</button>
				</div>
		</form>
	</div>

	<div id="page_knownunit_id" class="page hidden">
		<h1>Enter Master Password</h1>
		<form id="masterpwdform_knownid">
				<div>
					<p class="form-group">
					<label for="pwd_knownid">Password</label>
					<input type="password"
						title="masterpassword"
						name="masterpassword"
						data-validation="required"
						id="pwd_knownid"
					>
					</p>
				</div>
				<div>	
					<p class="form-group">
					<label class="inline" for='f_mpwd_knownid_save'>Store master password on USB</label>
					<input 
						type="checkbox" 
						name="save"
						id="f_mpwd_knownid_save"
					/>
					</p>
				</div>
				<div>
					<button 
						type="submit"
						id="btnPwdunlock"
						href="/reinit"
					>
					Continue</button>
				</div>
				
		</form>
	</div>
	
	<div id="page_restorebackup" class="page hidden">
		<h1>Restore data</h1>
		<p>
		Data backups found, please select a source to restore from.
		</p>
		<form id="restore_backup">
				<div>
					<p class="form-group">
					<select 
						title="source"
						name="path"
						id="restore_paths"
						data-validation="required"
						data-validation-error-msg="Data source must be selected"
					>
					<option disabled>Available sources</option>	
					</select>
					</p>
				</div>
				<button 
					type="submit"
					id="btnRestore"
					href="/restore"
					name="restore"
					value="1"
					class = "width_50 right"
				>
				Restore data</button>
		</form>
		<form id="cancel_restore">
					<input type="hidden" name="path" value=""/>
					<button 
						type="submit"
						href="/restore"
						class = "width_50 left"
						name = "restore"
						value = "0"
					>
					Skip restore</button>
		</form>

	</div>	
	<div id="validation_error" class="hidden">
		<div id="validation_error_msg"></div>
	</div>
	
	
	<div id="page_postinit" class="page hidden">
	<h1><span class="typename"></span> Unlocked</h1>
	<p>Waiting for normal operation</p>
	</div>


</section>
</div>

<script>

current_state = 0;

var restore_paths = Array();
var redirect_timeout = 10;
var maxpolls = 10;
var pollcount = 0;


$("button[type='cancel']").click(function() {
	setState(current_state);
});

$(".navbutton").click(function() {
	setState($(this).attr('opi-page'));
	$(".navbutton").removeClass("active");
	$(this).addClass("active");
	// only to populate with dummy data
	if($(this).attr('opi-page') == 5) {
		populate_paths(restore_paths);
	}
});

$("#btn-shutdown").click(function() {
	$(".page").addClass("hidden");
	$("#page_shutdown").removeClass("hidden");
});

function getQueryVariable(variable)
{
	// get a variable from the URL
	var query = window.location.search.substring(1);
	var vars = query.split("&");
	for (var i=0;i<vars.length;i++) {
	        var pair = vars[i].split("=");
	        if(pair[0] == variable){return pair[1];}
	}
	return(false);
}

function populate_paths(paths) {
	$("#restore_paths").empty();
	$("#restore_paths").append("<option disabled selected>Available sources</option>");	

	try {
		if(paths.remote.length > 0) {
			$("#restore_paths").append(
					"<optgroup label='-- OpenProducts remote server --'></optgroup>"
			)
			$.each(paths.remote,function(index,value) {
				$("#restore_paths").append(
					"<option value='"+value+"'>Backup from "+value.substring(value.lastIndexOf("/")+1,value.lastIndexOf("_"))+"</option>"
				);
			});
		}
	} catch(e){}

	try {
		if(paths.local.length > 0) {
			$("#restore_paths").append(
					"<optgroup label='-- Local (USB) --'></optgroup>"
			)
			$.each(paths.local,function(index,value) {
				$("#restore_paths").append(
					"<option value='"+value+"'>Backup from "+value.substring(value.lastIndexOf("/")+1,value.lastIndexOf("_"))+"</option>"
				);
			});

		}
	} catch(e){}
	
}


var pages = {
	0:"page_error",
	// 3:"page_knownunit_id",
	// 4:"page_knownunit_id",
	5:"page_restorebackup",
	6:"page_restoreinprogress",
	7:"page_user",
	10:"page_unlockpassword",
	13:"page_shutdownprogress",
	14:"page_rebootprogress",
	15:"page_postinit",
	17:"page_sderror",
	18:"page_opiname",
	19:"page_knownunit_id",
	20:"page_password",
	22:"page_storagemethod",
	80:"page_storagepartition",
	81:"page_storagedevice",
	99:"page_initprogress", // Local state not used on server side
}

function setState(state) {

	current_state = state;
	if( ! pages.hasOwnProperty( state ) )
	{
		switch(state) {
			case 1:
				console.log("State: " + state + ", show loading");
				$("#spinner-bg").removeClass("hidden");
				state = 99;
				break;
			default:
				console.log("Unknown state! "+state);
				current_state = 0;
				break;
		}
	}


	// remove possible error messages
	$("#validation_error_msg").text('');
	$("#validation_error").addClass("hidden");

	$(".page").addClass("hidden");

	for( var page in pages )
	{
		if( state == page ) 
		{
			$("#"+pages[page]).removeClass("hidden");
			$("#"+pages[page]).find("input, select").filter(':visible:first').focus();
			if( page != 99) {
				/* state 99 is show init in progress
				 * and is set prior to the sending of the form
				 * so it can not be allowed to reset the form */
				$.each($("form"),function() {
					if($(this).attr('id') != "pwdform") {
						// reset form to clear error markers.
						// do not reset the pwdform since that will reset the hidden (and required) unit_id field.
						$(this).get(0).reset();
					}
				});
			}
		}
	}

}

function redirect(url,timeout) {
	$(window).off("beforeunload");
	$("#spinner-bg").removeClass("hidden");
	setTimeout(function() {
		location.href = url;
	},timeout*1000);
}

function poll_restore()
{

	$.get("/status",function(data) {
		setState(data.state);

		if (data.progress.stateinfo &&  ( Number(data.progress.stateinfo.state) < Number(data.progress.stateinfo.max_states)) )  {
			$("#restorestate").text(data.progress.stateinfo.desc);
		}

		if ( data.progress.status && (data.progress.stateinfo.state < 5) ) {
			$("#progressinfo").removeClass("hidden");
			$("#file").text(data.progress.filename);
			$("#transferred").text(data.progress.transferred);
			$("#eta").text(data.progress.eta);
			$("#restoreprogress").width(data.progress.progress);
		} else {
			$("#progressinfo").addClass("hidden");
		}
	})
	.fail(function() {
		console.log("Poll restore request failed");
		if ( pollcount > maxpolls ) {
			setState(1);
		} else {
			pollcount++;
		}

	});

	if( current_state == 6 ) // doing restore
	{
		setTimeout( poll_restore, 5000 );
	}
	else if( current_state == 15 )
	{
		done("");
	}
}

function done(fqdn) {
	$.ajax({
		  type: "POST",
		  url: "/terminate",
		  contentType : "application/json",
		  data: '{"shutdown" : true}',
		})
		.done(function( result ) {
			if(result.status != true) {
				try {
					$("#validation_error_msg").text(result.errmsg);	
				} catch(err) {
				    console.log(err.message);
				}
				
			} else {
				// check for a valid fqdn, it is not available on a pure "unlock"
				p_fqdn = fqdn.split(".");
				if ( ! p_fqdn[0].length ) {
					// the fqdn start with a "." which is no good to use...
					console.log("Unusable 'fqdn'");
				} else {

				// is the unit accessed by OP's domain pointers?
				// could be "local." or IP also.
				console.log(domains);
				// is the access from the "local.devicename.domain.com" url?
				if(location.href.indexOf("local") > 0) {
					redirect("https://local."+fqdn,redirect_timeout);
					return true;
				} else {
					// do we have any of our domain in the url?
					for (i = 0; i < domains.length; i++) {
						if(location.href.indexOf(domains[i]) > 0) {
							redirect("https://"+fqdn,redirect_timeout);
							return true;
						}
					}
				}
				// something other in the url, just redirect to the new site on the same hostname
				}
				redirect("/admin",redirect_timeout);
			}
		})
		.fail(function() {
			setState(1);
		});
	
}

function setHelp(type="") {
	$.each($('input[title]'), function() {

		if (helptext[$(this).attr("helpindex")]) {
			console.log("helpindex found" + $(this).attr("helpindex"));
			console.log(helptext[$(this).attr("helpindex")]);
			$(this).attr("title", helptext[$(this).attr("helpindex")]);
		
		} else if (helptext[$(this).attr("name")+"_"+type]) {
			$(this).attr("title", helptext[$(this).attr("name")+"_"+type]);

		} else if (helptext[$(this).attr("name")]) {
			$(this).attr("title", helptext[$(this).attr("name")]);
		}

	});
}

function getType() {
	//console.log("Trying to determine system type");
	systype = false;
	$.get("/gettype",function(data) {
		if ( data.provider ) {
			// handle sprecific provider setups
			console.log("Setting up system for provider: "+data.provider);
			switch (data.provider.toLowerCase()) {
				case "openproducts":
					// enable unitid
					$("#div_unit_id").removeClass("hidden");
					$("#unit_id").attr("data-validation","custom");
					// enable OP domains
					$("#div-checkbox-customdomain").removeClass("hidden");
					$("#div-opdomains").removeClass("hidden");
					$("#select_domain").prop("disabled",false);
					// disable custom domain
					$("#div-customdomain").addClass("hidden");
					$("#help-customdomain").addClass("hidden");
					$("#customdomain").prop("disabled",true);
					$("#customdomain").prop("data-validation","");

					break;
				default:
					console.log("Nothing to do for provider: "+data.provider);
					break;
			}
		} else {
			console.log("No provider found.");
		}
		
		systype = data.type;
		if (data.type=="Armada") {
			$("span.typename").text("KEEP");
		} else {
			$("span.typename").text("OPI");
			redirect_timeout = 20;
		}
		setHelp(systype);
	}, "json" )
	.fail(function() {
		console.log("Request 'type' failed");
	});
	return systype;
}

function getDomains() {
	console.log("Retreiving available domains");
	domains = false;
	selected = "";
	$.get("/getdomains",function(data) {
		domains = data.domains;
		for (i = 0; i < domains.length; i++) {
	  		if ( domains[i] ) {
	  		  	console.log("Append "+domains[i]+" to domains");
	  		  	if(data.domain == domains[i]) {
	  		  		selected = 'selected="selected"';
	  		  	}
	  		  	else {
	  		  		selected = "";
	  		  	}

	  		  	$("#select_domain").append('<option value="'+domains[i]+'" '+selected+'>'+domains[i]+'</option>');
			} 
		}
		// set the default domain to selected value
		$("#domaincontainer").val( $("#select_domain").val() );
	}, "json" )
	.fail(function() {
		console.log("Request 'Domains' failed.");
	});
	return domains;
}


function setPhysical(list)
{
	for (i = 0; i < list.length; i++)
	{
		if ( list[i] )
		{
			console.log("Append "+list[i]+" to physical");
			$("#sel_physical").append(
				`<option value="${list[i].name}">${list[i].description}</option>`
			);
		}
	}
}

function setDevices(list)
{
	for (i = 0; i < list.length; i++)
	{
		if ( list[i] )
		{
			console.log("Append "+list[i]+" to devices");
			$("#sel_devices").append(
				`<option value="${list[i]['devpath']}">${list[i]['model']} (${list[i]['size']})</option>`
		);
		}
	}
}

function setPartitions(list)
{
	for (i = 0; i < list.length; i++)
	{
		if ( list[i] )
		{
			console.log("Append "+list[i]+" to partitions");
			$("#sel_partitions").append(
			`<option value="${list[i]['devpath']}">${list[i]['model']} (${list[i]['size']})</option>`
		);
		}
	}
}

function setLogical(list)
{
	for (i = 0; i < list.length; i++)
	{
		if ( list[i] )
		{
			console.log("Append "+list[i]+" to logical");

			$("#sel_device_logical").append(
				`<option value="${list[i].name}">${list[i].description}</option>`
			);

			$("#sel_part_logical").append(
				`<option value="${list[i].name}">${list[i].description}</option>`
			);
		}
	}
}

function setEncryption(list)
{
	for (i = 0; i < list.length; i++)
	{
		if ( list[i] )
		{
			console.log("Append "+list[i]+" to encryption");
			$("#sel_device_encrypt").append(
				`<option value="${list[i].name}">${list[i].description}</option>`
			);

			$("#sel_part_encrypt").append(
				`<option value="${list[i].name}">${list[i].description}</option>`
			);

		}
	}
}

function getStorageDevices()
{
	console.log("Retrieving possible storage devices");
	let devices = false;
	$.get("/storagedevices", function(data) {
		setPhysical(data.storagephysical);
		setDevices(data.storagedevices);
		setPartitions(data.storagepartitions);
		setLogical(data.storagelogical);
		setEncryption(data.storageencryption)
	}, "json" )
	.fail(function() {
		console.log("Request storage devices failed");
	});
	return devices;
}

function getStatus() {
	$.get("/status",function(data) {
		
		setState(data.state);	
		console.log("getStatus state: " + data.state);
		switch ( data.state ) {
		case 1:
			// add all states here that we want to wait for
			// and that has been triggered by a page reload
			console.log("Trigger poll");
			setTimeout( getStatus(), 2000 );
			break;
		case 5:
			// expecting cached content here for backup paths.
			if (data.cache) {
				var paths = {local:data.cache.local, remote:data.cache.remote};
				populate_paths(paths);
			} else {
				console.log("Expected cached content, but did not find any.");
			}
			break;

		case 6:  
			// Restore in progress
			poll_restore();
			break;
		case 15:  
			// System is unlocked, send terminate signal.
			done("");
			break;


		default:
			console.log("Nothing to do for state:" + data.state);
			break;
		}

	})
	.fail(function() {
		setState(1);	
		console.log("request failed");
	});	
}

var opiname_check = false;
function checkname() {
	// Do not check with server for custom domains.
	if(opiname_check) opiname_check.abort(); // abort any ongoing checks


	if ($("#opiname").val() == "") {
			$("#opi_namestate").parent().removeClass("has-success");
			$("#opi_namestate").parent().removeClass("has-error");
			$("#opi_namestate").text("");
			return;
	}


	var allowedChars = new RegExp("^([a-z0-9](?:[a-z0-9-]*[a-z0-9]))$");
	if ( ! allowedChars.test($("#opiname").val()) ){
		$("#opi_namestate").parent().addClass("has-error");
		$("#opi_namestate").text("Use only 'a-z', 0-9 and '-'.");
		console.log("Illegal character found.");
		return;
	}

	// set the active domain value to domain containder id
	if (! $("#select_domain").is(":enabled")) {
		$("#domaincontainer").val( $("#customdomain").val() );
		console.log("Setting domain to custom domain name:" + $("#domaincontainer").val() );
		return;
	} else {
		domain = $("#select_domain").val();
		$("#domaincontainer").val( domain );
		console.log("Setting domain to: " + $("#domaincontainer").val());
	}
	/*
	} else if ($("#customdomain").is(":enabled") && ($("#customdomain").val() != "") ) {
		domain = $("#customdomain").val();
	} else {
		domain = "";
	}
	*/
	opiname_check = $.ajax({
		url : "/checkname",
		data : JSON.stringify({ opiname : $("#opiname").val(), domain : domain}),
		contentType : "application/json",
		type : "POST",
	}).done(function(data) {
		if(data.available) {
			$("#opi_namestate").text("Name available");
			$("#opi_namestate").parent().addClass("has-success");
			$("#opi_namestate").parent().removeClass("has-error");
			$("#btnOpiname").removeAttr("disabled","disabled");
			console.log("NAME OK");
		} else {
			$("#opi_namestate").text("Name not available");
			$("#opi_namestate").parent().addClass("has-error");
			$("#opi_namestate").parent().removeClass("has-success");
			$("#btnOpiname").attr("disabled","disabled");
			console.log("NAME NOT OK");
		}
	});	
}

$("#opiname").keyup( function() {
	checkname();
});
$("#customdomain").keyup( function() {
	checkname();
});
$("#select_domain").change( function() {
	checkname();
});

$("#checkbox-customdomain").change( function() {
	if ( $(this).prop("checked") ) {
		console.log("checked");
	} else {
		console.log("cleared");
	}
	console.log("checkbox val:" + $(this).val());
	if ($(this).prop("checked")) {
		$("#div-customdomain").hide();
		$("#div-customdomain").removeClass("hidden");
		$("#div-customdomain").slideDown();
		$("#div-opdomains").slideUp();
		$("#div-opdomains").slideUp();
		$("#customdomain").prop("disabled",false);
		$("#select_domain").prop("disabled",true);
	} else {
		$("#div-customdomain").slideUp();
		$("#div-opdomains").slideDown();		
		$("#customdomain").prop("disabled",true);
		$("#select_domain").prop("disabled",false);
	}
	checkname();
});

$("input").keypress(function(e) {
	if(e.which != 13) {
	$("#validation_error_msg").text('');
	$("#validation_error").addClass("hidden");
	}
});

/*
$(window).bind('beforeunload', function(){
	console.log("Confirm leave.");
  	return "Leaving?";
});
*/

/* Variable to temp store data on storage selection (Not pretty) */
var stor_sel = {}

function getSelectedItems( sel )
{
	var ret = []

	for(var s=0; s< sel.options.length; s++)
	{
		if( sel.options.item(s).selected )
		{
			ret.push( sel.options.item(s).value);
		}
	}
	return ret;
}

$(document).ready( function() {
	var unit_id;

	type=getType();
	domains=getDomains();
	devices=getStorageDevices();

	$("input[type='text']").addClass("form-control");
	$("input[type='password']").addClass("form-control");
	$("button").addClass("btn").addClass("btn-primary");
	$(".page button").addClass("fullwidth");
	unit_id = getQueryVariable('unit_id');
	if(unit_id) {
		var re = new RegExp(/[\w\d\-]{36}/);
		if(re.test(unit_id)) {
			$("#unit_id").val(unit_id);
			$("#div_unit_id").addClass("hidden");
		}
	}	 
	
	if($( window ).width() < 805) {
		qtip_pos_my =  'top center';
		qtip_pos_at =	'center center';
		qtip_pos_adjust = { 
					y : 25,
					x : 25
				}
	} else {
		qtip_pos_my =  'left bottom';
		qtip_pos_at =	'top right';
		qtip_pos_adjust = { }
	}
	$('input[title]').qtip({
		show: 'focus',
		hide: 'blur',
		position : {
			my	: qtip_pos_my,
			at : qtip_pos_at,
			adjust : qtip_pos_adjust,
			container : $('#login')
		},
		style: {
        	classes: 'qtip-rounded qtip-shadow',
        	width : '225px'
		}
	});

	setHelp();

	$.validate( {
		modules : 'security',
		onModulesLoaded : function() {
			/*
			var optionalConfig = {
				fontSize: '10px',
				padding: '0px',
				bad : 'WEAK PASSWORD',
				weak : 'WEAK PASSWORD',
				good : 'FAIR PASSWORD',
				strong : 'STRONG PASSWORD',
			};
			*/
			var optionalConfig = {
				fontSize: '10px',
				padding: '0px',
				bad : '',
				weak : '',
				good : '',
				strong : '',
			};
			//$('input[name="masterpassword_confirmation"]').displayPasswordStrength(optionalConfig);
			//$('input[name="password_confirmation"]').displayPasswordStrength(optionalConfig);
		},
		onSuccess : function($form) {
			url = $form.find("button[type='submit']").attr('href');
			if( (url == "/init") || (url == "/reinit") ) {
				// trying to init, show init info to user
				setState(99);
			}

			if( url == "/stor_sel" )
			{
				el = $("#sel_physical")[0]
				method = el.options[el.selectedIndex].value
				console.log("Selected method:"+method )
				stor_sel["physical"]=method
				if( method == "none" )
				{
					stor_sel["devices"] = [];
					stor_sel["logical"] = "none";
					stor_sel["encryption"] = "none";
					url = "/devices"
				}
				else if( method == "partition" )
				{
					setState(80);
					return false;
				}
				else if( method == "block" )
				{
					setState(81);
					return false;
				}
			}

			if( url == "/stor_dev")
			{
				console.log("Select device");
				stor_sel["devices"] = getSelectedItems($("#sel_devices")[0]);
				stor_sel["logical"] = $("#sel_device_logical")[0].value;
				stor_sel["encryption"]= $("#sel_device_encrypt")[0].value;

				url = "/devices";
			}

			if( url == "/stor_part")
			{
				console.log("Select partition");
				stor_sel["devices"] = getSelectedItems($("#sel_partitions")[0]);
				stor_sel["logical"] = $("#sel_part_logical")[0].value;
				stor_sel["encryption"]= $("#sel_part_encrypt")[0].value;

				url = "/devices";
			}

			// collect the form data while iterating over the inputs
			var data = {};

			if( url != "/devices")
			{
				formdata = $form.find("input, select, button");
				for (var i = 0, ii = formdata.length; i < ii; ++i) {
					var input = formdata[i];

					if (input.name) {
						if( input.type == "checkbox" ) {
							data[input.name] = input.checked;
						} else if ( input.type == "select-multiple" ) {
							data[input.name] = getSelectedItems(input);
						} else {
							data[input.name] = input.value;
						}
					}
				}
			}
			else
			{
				data = stor_sel;
			}

			if(button = $form.children('button')) {
				data[button.attr('name')] = button.val(); 
			}

			$("#spinner-bg").removeClass("hidden");
			$.ajax({
				type: "POST",
				url: url,
				contentType : "application/json",
				data: JSON.stringify(data),
			})
			.done(function( result ) {
				if(result.status != true) {
					$("#validation_error").removeClass("hidden");
					try {
						$("#validation_error_msg").text(result.errmsg);
						setState(result.state);
					} catch(err) {
						$("#validation_error_msg").text(err.message);
						console.log(err.message);
					}

					if (result.state == 18) {
						console.log("state 18");
						// opi name state
						$("#opi_namestate").text("Name not available/denied");
						$("#opi_namestate").parent().removeClass("has-success");
						$("#opi_namestate").parent().addClass("has-error");
						$("#btnOpiname").attr("disabled","disabled");
					}

						
				} else {
					// clear opiname input box messages
					$("#opi_namestate").text("");
					$("#opi_namestate").parent().removeClass("has-success");
					$("#opi_namestate").parent().removeClass("has-error");
					$("#btnOpiname").removeAttr("disabled","disabled");
					// set the opiname variable before the clearing all fields
					// done by set state
					fqdn = $("#opiname").val()+"."+$("#select_domain").val();
					setState(result.state);
					if(result.state == 5) {
						// make paths globally available
						var paths = {local:result.local, remote:result.remote};
						populate_paths(paths);
					}

					if( result.state == 6 ) // Restore in progress
					{
						poll_restore();
					}

					if(result.url) {
							try {
								redirect(result.url,result.timeout);
							} catch(err) {
								setState(1);
								console.log(err.message);
							}
					} else {
						if(result.state == 15 ) {
							// this will send the "terminate" signal to opi-control
							// then redirect to "/admin"
							done(fqdn);
						}
					}	
				}
				})
			.fail(function() {
				setState(1);
			})
			.always(function(result){
				if(!result.url) {
					$("#spinner-bg").addClass("hidden");
				}
			});

			// return false to prevent "normal" submit of the form.
			return false;
		},
		onError : function($form) {
			console.log("Validation Failed");
			return false;
		}

	});
	console.log("Call getStatus, state: " + current_state);
	getStatus();
	
});
</script>
</body>
</html>
