
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>OPI Setup</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
<!--
    <link rel="stylesheet" href="https://localhost/css/app.css">
    <script src="https://localhost/js/jquery.min.js"></script>
    <script src="https://localhost/js/form-validator/jquery.form-validator.min.js"></script>
    
-->
    <link rel="stylesheet" href="css/app.css">
    <link rel="stylesheet" href="css/init.css">
    <link rel="stylesheet" href="css/jquery.qtip.min.css">
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery.qtip.min.js"></script>
    <script src="js/helptexts.js"></script>
    <script src="js/form-validator/jquery.form-validator.min.js"></script>

</head>
<body class="claro" id="theBody">
<nav id="nav-shutdown">
	<div id="shutdown">
		<button type="button" class="shutdown" id="btn-shutdown"><img src='img/shutdown.png' /><span>Shutdown OPI</span></button>
	</div>
</nav>

<div id="spinner-bg" class="hidden">
	<div id="spinner">
		<img src='img/spinner.gif' />
	</div>
</div>

<div id="login-bg">
<section id="login">
	<div id="nav" class="hidden">
	<button type="button" class="navbutton" opi-page="1" id="b1" title="">1</button>
	<button type="button" class="navbutton" opi-page="2" id="b2" title="">2</button>
	<button type="button" class="navbutton" opi-page="3" id="b3" title="">3</button>
	<button type="button" class="navbutton" opi-page="4" id="b4" title="">4</button>
	<button type="button" class="navbutton" opi-page="5" id="b5" title="">5</button>
	<button type="button" class="navbutton" opi-page="6" id="b6" title="">6</button>
	<button type="button" class="navbutton" opi-page="7" id="b7" title="">7</button>
	<button type="button" class="navbutton" opi-page="8" id="b8" title="">8</button>
	<button type="button" class="navbutton" opi-page="9" id="b9" title="">9</button>
	<button type="button" class="navbutton" opi-page="10" id="b10" title="">10</button>
	<button type="button" class="navbutton" opi-page="11" id="b11" title="">11</button>
	</div>
	<div id="page_error" class="page hidden">
	<h1>Error - Unable to retrieve status</h1>
	<p>OPI replied with an unknown error</p>
	</div>
	
	<div id="page_shutdown" class="page hidden">
		<center><h1>Confirm shutdown of OPI</h1></center>
		<p></p>
		<div class="sd-buttons">
			<form>
				<button 
					type="submit" 
					id="sd-btn-shutdown" 
					href="/shutdown"
					name="action"
					value="shutdown"
					class="width_50">
					Shutdown
				</button>
			</form>
			<form>
				<button 
					type="submit" 
					id="sd-btn-reboot" 
					href="/shutdown"
					name="action"
					value="reboot"
					class="width_50 btn-right">
					Reboot
				</button>
			</form>
		</div>
		<div class="sd-buttons">
			<button 
				type="cancel" 
				id="sd-btn-cancel" 
				class="fullwidth">
				Cancel
			</button>
		</div>
		</form>
	</div>

	<div id="page_sderror" class="page hidden">
		<h1>Error - No SD card detected</h1>
		<p>Please insert SD card and restart OPI</p>
	</div>

	<div id="page_initprogress" class="page hidden">
		<h1>Initializing OPI</h1>
		<p>Please have patience, initializing may take a while</p>
	</div>
	
	<div id="page_shutdownprogress" class="page hidden">
		<h1>OPI shutdown in progress</h1>
		<p>Please to not remove power until all LEDs are turned off.</p>
	</div>

	<div id="page_rebootprogress" class="page hidden">
		<h1>OPI reboot in progress</h1>
		<p>OPI is rebooting, please wait ...</p>
	</div>

	<div id="page_password" class="page hidden">
		<h1>Select master password</h1>
		<form id="pwdform">
			<div id="div_unit_id">
				<p class="form-group">
				<label for 'unit_id'>OPI activation code</label>
				<input
					title = "unit_id"
					type ="text"
					id ="unit_id"
					name ="unit_id"
					data-validation="custom"
					data-validation-regexp= '[\w\d\-]{36}'
				/> 
				</p>
			</div>
			<div>					
				<p class="form-group">
				<label for 'masterpassword_confirmation'>Password</label>
				<input
					title="Master"
					type="password" 
					name="masterpassword_confirmation"
					data-validation="required" 
					data-validation-strength="1"
				/>
				</p>
			</div>
			<div>	
				<p class="form-group">
				<label for 'masterpassword'>Confirm Password</label>
				<input 
					type="password" 
					name="masterpassword"
					data-validation="confirmation"
					data-validation="required"
					data-validation-error-msg="Passwords do not match"
				/>
				</p>
			</div>
			<div>
				<button 
					type="submit" 
					id="btnPwd" 
					href="/init">
				Continue
				</button>
			</div>
		</form>
	</div>
	
	
	
	<div id="page_user" class="page hidden">
		<h1>Add first user</h1>
		<form id="userform">
			<div>
				<p class="form-group">
				<label for 'username'>Username</label>
				<input type="text" 	id="username"
					name="username"
					title="Username"
					data-validation="required"
					class="lowercase"
					data-validation-error-msg="Missing 'username'"
					/>
				</p>
			</div>
			<div>	
				<p class="form-group">
				<label for 'displayname'>Real name</label>
				<input type="text"
					name="displayname"
					title="Displayname"
					data-validation="required"
					data-validation-error-msg="Missing 'Real name'"
					/>
				</p>
			</div>
			<div>	
				<p class="form-group">
				<label for 'password'>Password</label>
				<input type="password"
					title="userpassword"
					name="password_confirmation"
					data-validation="required"
					data-validation-strength="1"
					data-validation-error-msg=" "
					/>
				</p>
			</div>
			<div>	
				<p class="form-group">
				<label for 'password'>Confirm password</label>
				<input type="password"
					name="password"
					data-validation="confirmation"
					data-validation="required"
					data-validation-error-msg="Passwords do not match"
				/>
				</p>
			</div>
			<div>
				<button 
					type="submit" 
					id="btnUser"
					href="/user" >
				Continue</button>
			</div>
		</form>
	</div>
	
	<div id="page_opiname" class="page hidden">
		<h1>Select OPI name</h1>
		<form id="opinameform">
			<div>
				<p class="form-group">
				<label for "opiname">OPI name</label>
				<input 
					type="text" 	
					id="opiname"
					name="opiname"
					title="OPI name"
					data-validation="required"
					data-validation="alphanumeric" data-validation-allowing="-_"
					class="lowercase"
					data-validation-error-msg="OPI name is required during setup"
				/>
				<span id="opi_namestate" class="help-block form-error"></span>
				</p>
				<div>
					<button 
						type="submit"
						id="btnOpiname"
						href="/opiname"
					>
					Continue</button>
				</div>
			</div>
		</form>
	</div>
	
	<div id="page_unlockpassword" class="page hidden">
		<h1>Enter master password</h1>
		<form id="masterpwdform">
				<div>
					<p class="form-group">
					<label for "password">Password</label>
					<input type="password"
						title="masterpassword"
						name="masterpassword"
						data-validation="required"
					>
					</p>
				</div>
				<div>
					<button 
						type="submit"
						id="btnPwdunlock"
						href="/unlock"
					>
					Continue</button>
				</div>
		</form>
	</div>

	<div id="page_knownunit_id" class="page hidden">
		<h1>Enter master password</h1>
		<form id="masterpwdform">
				<div>
					<p class="form-group">
					<label for "password">Password</label>
					<input type="password"
						title="masterpassword"
						name="masterpassword"
						data-validation="required"
					>
					</p>
				</div>
				<div>
					<button 
						type="submit"
						id="btnPwdunlock"
						href="/reinit"
					>
					Continue</button>
				</div>
		</form>
	</div>
	
	<div id="validation_error" class="hidden">
		<div id="validation_error_msg"></div>
	</div>
	
	
	<div id="page_postinit" class="page hidden">
	<h1>OPI unlocked</h1>
	<p>Waiting for normal operation</p>
	</div>


</section>
</div>


</body>
<script>

current_state = 0;

$("button[type='cancel']").click(function() {
	setState(current_state);
});

$(".navbutton").click(function() {
	setState($(this).attr('opi-page'));
});

$("#btn-shutdown").click(function() {
	$(".page").addClass("hidden");
	$("#page_shutdown").removeClass("hidden");
});

function getQueryVariable(variable)
{
       var query = window.location.search.substring(1);
       var vars = query.split("&");
       for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){return pair[1];}
       }
       return(false);
}


function setState(state) {
	current_state = state;
	var pages = [
		"page_error", 
		"page_sderror", 
		"page_password",
		"page_user",
		"page_opiname",
		"page_unlockpassword",
		"page_postinit",
		"page_initprogress",
		"page_knownunit_id",
		"page_shutdownprogress",
		"page_rebootprogress"];
	
	if( state < 1 || state > pages.length)
	{
		console.log("Unknown state! "+state);
		state = 1;
	}

	$(".page").addClass("hidden");
	for( i=1; i <= pages.length; ++i)
	{
		if(i==state) {
			$("#"+pages[i-1]).removeClass("hidden");
			$("#"+pages[i-1]).find("input").filter(':visible:first').focus();
			$.each($("form"),function() {
				if($(this).attr('id') != "pwdform") {
					// reset form to clear error markers.
					// do not reset the pwdform since that will reset the hidden (and required) unit_id field.
					$(this).get(0).reset();
				}
			});
		}
	} 
}

function redirect(url,timeout) {
	$("#spinner-bg").removeClass("hidden");
	setTimeout(function() {
		location.href = url;
	},timeout*1000);
}

function done() {
	$.ajax({
		  type: "POST",
		  url: "/terminate",
		  contentType : "application/json",
		  data: '{"shutdown" : true}',
		})
		.done(function( result ) {
			if(result.status != true) {
				try {
					$("#validation_error_msg").text(result.errmsg);	
				} catch(err) {
				    console.log(err.message);
				}
				
			} else {
				redirect("/admin",5);
			}
		})
		.fail(function() {
			setState(1);
		});
	
}

var opiname_check = false;
$("#opiname").keyup( function() {
	if(opiname_check) opiname_check.abort(); // abort any ongoing checks 
	opiname_check = $.ajax({
		url : "/checkname",
		data : JSON.stringify({ opiname : $("#opiname").val()}),
		contentType : "application/json",
		type : "POST",
	}).done(function(data) {
		if(data.available) {
			$("#opi_namestate").text("Name available");
		} else {
			$("#opi_namestate").text("Name not available");
		}
	});	
});

$("input").keyup(function() {
	$("#validation_error_msg").text('');
	$("#validation_error").addClass("hidden");
});

$(document).ready( function() {
	var unit_id;
	
	// fix margin if we are running in a small browser.
	if($(window).width() < 760) {
		margin = ($(window).width() - 400)/2; 
		$("#login").css("marginLeft",margin+"px");
	}
	
	$("input[type='text']").addClass("form-control");
	$("input[type='password']").addClass("form-control");
	$("button").addClass("btn").addClass("btn-primary");
	$(".page button").addClass("fullwidth");
	unit_id = getQueryVariable('unit_id');
	if(unit_id) {
		var re = new RegExp(/[\w\d\-]{36}/);
		if(re.test(unit_id)) {
			$("#unit_id").val(unit_id);
			$("#div_unit_id").addClass("hidden");
		}
	}
	 
	
    $('input[title]').qtip({
        show: 'focus',
        hide: 'blur',
        position : {
	        my: 'left bottom',
	        at: 'top right'
        }
    });
    $.each($('input[title]'), function() {
    	if(helptext[$(this).attr("name")]) {
    		$(this).attr("title", helptext[$(this).attr("name")]);
    	}
    });

	
	$.validate( {
		modules : 'security',
		onModulesLoaded : function() {
			/*
		    var optionalConfig = {
		      fontSize: '10px',
		      padding: '0px',
		      bad : 'WEAK PASSWORD',
		      weak : 'WEAK PASSWORD',
		      good : 'FAIR PASSWORD',
		      strong : 'STRONG PASSWORD',
		    };
			*/
		    var optionalConfig = {
				      fontSize: '10px',
				      padding: '0px',
				      bad : '',
				      weak : '',
				      good : '',
				      strong : '',
				    };
		    //$('input[name="masterpassword_confirmation"]').displayPasswordStrength(optionalConfig);
		    //$('input[name="password_confirmation"]').displayPasswordStrength(optionalConfig);
		},
		onSuccess : function($form) {
			url = $form.find("button[type='submit']").attr('href');
			if( (url == "/init") || (url == "/reinit") ) {
				// trying to init, show init info to user
				setState(8);
			}
			  // collect the form data while iterating over the inputs
			  formdata = $form.find("input");
			  var data = {};
			  for (var i = 0, ii = formdata.length; i < ii; ++i) {
			    var input = formdata[i];
			    if (input.name) {
			      data[input.name] = input.value;
			    }
			  }
			  if(button = $form.children('button')) {
				  data[button.attr('name')] = button.val(); 
			  }
			  $("#spinner-bg").removeClass("hidden");
			$.ajax({
				  type: "POST",
				  url: url,
				  contentType : "application/json",
				  data: JSON.stringify(data),
				})
				.done(function( result ) {
					if(result.status != true) {
						$("#validation_error").removeClass("hidden");
						try {
							$("#validation_error_msg").text(result.errmsg);
							setState(result.state);
						} catch(err) {
							$("#validation_error_msg").text(err.message);
						    console.log(err.message);
						}
						
					} else {
						setState(result.state);
						if(result.url) {
							try {
								redirect(result.url,result.timeout);
							} catch(err) {
								setState(1);
								console.log(err.message);
							}
						} else {
							if(result.state == 7 ) {
								// this will send the "terminate" signal to opi-control
								// then redirect to "/admin"
								done();
							}
						}	
					}
				})
				.fail(function() {
					setState(1);
				})
				.always(function(result){
					if(!result.url) {
						$("#spinner-bg").addClass("hidden");
					}
				});
			return false;
		},
		onError : function($form) {
			console.log("Validation Failed");
			return false;
		}

	});
	
	$.get("/status",function(data) {
		//console.log(data);
		setState(data.state);
	})
	.fail(function() {
		setState(1);	
		console.log("request failed");
	});
	
});
</script>
</html>
