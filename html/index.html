<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>Setup</title>
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Expires" content="0">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    
	<link rel="stylesheet" href="css/app.css">
	<link rel="stylesheet" href="css/init.css">
	<link rel="stylesheet" href="css/jquery.qtip.min.css">
	<script src="js/jquery.min.js"></script>
	<script src="js/jquery.qtip.min.js"></script>
	<script src="js/helptexts.js"></script>
	<script src="js/form-validator/jquery.form-validator.min.js"></script>

</head>
<body class="claro" id="theBody">
<nav id="nav-shutdown">
	<div id="shutdown">
		<button type="button" class="shutdown" id="btn-shutdown"><img src='img/shutdown.png' /><span>Shutdown <span class="typename"></span></span></button>
	</div>
</nav>

<div id="spinner-bg" class="hidden">
	<div id="spinner">
		<img src='img/spinner.gif' />
	</div>
</div>

<div id="login-bg">
<section id="login">
	<div id="nav" class="hidden">
	<button type="button" class="navbutton" opi-page="1" id="b1" title="">1</button>
	<button type="button" class="navbutton" opi-page="2" id="b2" title="">2</button>
	<button type="button" class="navbutton" opi-page="3" id="b3" title="">3</button>
	<button type="button" class="navbutton" opi-page="4" id="b4" title="">4</button>
	<button type="button" class="navbutton" opi-page="5" id="b5" title="">5</button>
	<button type="button" class="navbutton" opi-page="6" id="b6" title="">6</button>
	<button type="button" class="navbutton" opi-page="7" id="b7" title="">7</button>
	<button type="button" class="navbutton" opi-page="8" id="b8" title="">8</button>
	<button type="button" class="navbutton" opi-page="9" id="b9" title="">9</button>
	<button type="button" class="navbutton" opi-page="10" id="b10" title="">10</button>
	<button type="button" class="navbutton" opi-page="11" id="b11" title="">11</button>
	<button type="button" class="navbutton" opi-page="12" id="b12" title="">12</button>
        <button type="button" class="navbutton" opi-page="13" id="b13" title="">13</button>
        <button type="button" class="navbutton" opi-page="14" id="b14" title="">14</button>
        <button type="button" class="navbutton" opi-page="15" id="b15" title="">15</button>
        <button type="button" class="navbutton" opi-page="16" id="b16" title="">16</button>
        <button type="button" class="navbutton" opi-page="17" id="b17" title="">17</button>
	</div>
	<div id="page_error" class="page hidden">
	<h1>Error - Unable to retrieve status</h1>
	<p>Server replied with an unknown error</p>
	</div>

	<div id="page_restoreinprogress" class="page hidden">
		<h1>Restore in progress</h1>
		<p>Data restore in progress, please wait</p>
	</div>
	
	<div id="page_shutdown" class="page hidden">
		<center><h1>Confirm shutdown</h1></center>
		<p></p>
		<div class="sd-buttons">
			<form>
				<button 
					type="submit" 
					id="sd-btn-shutdown" 
					href="/shutdown"
					name="action"
					value="shutdown"
					class="width_50">
					Shutdown
				</button>
			</form>
			<form>
				<button 
					type="submit" 
					id="sd-btn-reboot" 
					href="/shutdown"
					name="action"
					value="reboot"
					class="width_50 btn-right">
					Reboot
				</button>
			</form>
		</div>
		<div class="sd-buttons">
			<button
				type="cancel"
				id="sd-btn-cancel"
				class="fullwidth">
				Cancel
			</button>
		</div>
	</div>

	<div id="page_sderror" class="page hidden">
		<h1>Error - No storage detected</h1>
		<p>Please insert SD card / hard drive and restart</p>
	</div>

	<div id="page_initprogress" class="page hidden">
		<h1>Initializing ...</h1>
		<p>Please have patience, initializing takes a while</p>
	</div>
	
	<div id="page_shutdownprogress" class="page hidden">
		<h1>Shutdown in progress</h1>
		<p>Please to not remove power until all LEDs are turned off.</p>
	</div>

	<div id="page_rebootprogress" class="page hidden">
		<h1>Unit reboot in progress</h1>
		<p>System is rebooting, please wait ...</p>
	</div>

	<div id="page_password" class="page hidden">
		<h1>Select Master Password</h1>
		<form id="pwdform">
			<div id="div_unit_id">
				<p class="form-group">
				<label for='unit_id'><span class="typename"></span> Activation Code</label>
				<input
					title = "unit_id"
					type ="text"
					id ="unit_id"
					name ="unit_id"
					data-validation="custom"
					data-validation-regexp= '^[\w\d\-]{36}$'
				/> 
				</p>
			</div>
			<div>					
				<p class="form-group">
				<label for='masterpassword_confirmation'>Password</label>
				<input
					title="Master"
					type="password" 
					name="masterpassword_confirmation"
					data-validation="required" 
					data-validation-strength="1"
				/>
				</p>
			</div>
			<div>	
				<p class="form-group">
				<label for='masterpassword'>Confirm Password</label>
				<input 
					type="password" 
					name="masterpassword"
					data-validation="confirmation"
					data-validation="required"
					data-validation-error-msg="Passwords do not match"
				/>
				</p>
			</div>
			<div>	
				<p class="form-group">
				<label class="pwd_on_usb" for='f_pwdform_save'>Store master password on USB</label>
				<input 
					type="checkbox" 
					name="save"
					id="f_pwdform_save"
				/>
				</p>
			</div>
			<div>
				<button 
					type="submit" 
					id="btnPwd" 
					href="/init">
				Continue
				</button>
			</div>
		</form>
	</div>
	
	
	
	<div id="page_user" class="page hidden">
		<h1>Add First User</h1>
		<form id="userform">
			<div>	
				<p class="form-group">
				<label for='displayname'>Real Name</label>
				<input type="text"
					name="displayname"
					title="Displayname"
					data-validation="required"
					data-validation-error-msg="Missing 'Real name'"
					/>
				</p>
			</div>
			<div>
				<p class="form-group">
				<label for='username'>Username</label>
				<input type="text" 	id="username"
					name="username"
					title="Username"
					data-validation-error-msg="Only lowercase 'a-z' allowed in username"
					data-validation="custom" data-validation-regexp="^([a-z]+)$"
					/>
				</p>
			</div>
			<div>	
				<p class="form-group">
				<label for='password'>Password</label>
				<input type="password"
					title="userpassword"
					name="password_confirmation"
					data-validation="required"
					data-validation-strength="1"
					data-validation-error-msg=" "
					/>
				</p>
			</div>
			<div>	
				<p class="form-group">
				<label for='password'>Confirm Password</label>
				<input type="password"
					name="password"
					data-validation="confirmation"
					data-validation="required"
					data-validation-error-msg="Passwords do not match"
				/>
				</p>
			</div>
			<div>
				<button 
					type="submit" 
					id="btnUser"
					href="/user" >
				Continue</button>
			</div>
		</form>
	</div>
	
	<div id="page_opiname" class="page hidden">
		<h1>Select Device Name</h1>
		<form id="opinameform">
			<div>
				<p class="form-group">
				<label for="domain">Select domain to use</label>
				<select
					id="select_domain"
					name="domain"
					title="Domain name"
				>
				</select>
				</p>
				<p class="form-group">
				<label for="opiname">Device name</label>
				<input 
					type="text" 	
					id="opiname"
					name="opiname"
					title="OPI name"
					data-validation="alphanumeric" data-validation-allowing="-_"
					class="lowercase"
					data-validation-error-msg="Device name is required during setup, ('a-z,-' allowed)"
				/>
				<span id="opi_namestate" class="help-block form-nameerror"></span>
				</p>
				<div>
					<button 
						type="submit"
						id="btnOpiname"
						href="/opiname"
					>
					Continue</button>
				</div>
			</div>
		</form>
	</div>
	
	<div id="page_unlockpassword" class="page hidden">
		<h1>Enter master password</h1>
		<form id="masterpwdform">
				<div>
					<p class="form-group">
					<label for="password">Password</label>
					<input type="password"
						title="masterpassword"
						name="masterpassword"
						data-validation="required"
					>
					</p>
				</div>
				<div>	
					<p class="form-group">
					<label class="pwd_on_usb"  for='f_mpwd_save'>Store master password on USB</label>
					<input
						id="f_mpwd_save" 
						type="checkbox" 
						name="save"
					/>
					</p>
				</div>
				<div>
					<button 
						type="submit"
						id="btnPwdunlock"
						href="/unlock"
					>
					Continue</button>
				</div>
		</form>
	</div>

	<div id="page_knownunit_id" class="page hidden">
		<h1>Enter Master Password</h1>
		<form id="masterpwdform_knownid">
				<div>
					<p class="form-group">
					<label for="pwd_knownid">Password</label>
					<input type="password"
						title="masterpassword"
						name="masterpassword"
						data-validation="required"
						id="pwd_knownid"
					>
					</p>
				</div>
				<div>	
					<p class="form-group">
					<label class="pwd_on_usb" for='f_mpwd_knownid_save'>Store master password on USB</label>
					<input 
						type="checkbox" 
						name="save"
						id="f_mpwd_knownid_save"
					/>
					</p>
				</div>
				<div>
					<button 
						type="submit"
						id="btnPwdunlock"
						href="/reinit"
					>
					Continue</button>
				</div>
				
		</form>
	</div>
	
	<div id="page_restorebackup" class="page hidden">
		<h1>Restore data</h1>
		<p>
		Data backups found, please select a source to restore from.
		</p>
		<form id="restore_backup">
				<div>
					<p class="form-group">
					<select 
						title="source"
						name="path"
						id="restore_paths"
						data-validation="required"
						data-validation-error-msg="Data source must be selected"
					>
					<option disabled>Available sources</option>	
					</select>
					</p>
				</div>
				<button 
					type="submit"
					id="btnRestore"
					href="/restore"
					name="restore"
					value="1"
					class = "width_50 right"
				>
				Restore data</button>
		</form>
		<form id="cancel_restore">
					<input type="hidden" name="path" value=""/>
					<button 
						type="submit"
						href="/restore"
						class = "width_50 left"
						name = "restore"
						value = "0"
					>
					Skip restore</button>
		</form>
	</div>	
	<div id="validation_error" class="hidden">
		<div id="validation_error_msg"></div>
	</div>
	
	
	<div id="page_postinit" class="page hidden">
	<h1><span class="typename"></span> Unlocked</h1>
	<p>Waiting for normal operation</p>
	</div>


</section>
</div>

<script>

current_state = 0;

// set dummy paths
var restore_paths = Array();
restore_paths['local'] = ["/path/1","/path/2"];
restore_paths['remote'] = ["/path/3","/path/4"];
$("button[type='cancel']").click(function() {
	setState(current_state);
});

$(".navbutton").click(function() {
	setState($(this).attr('opi-page'));
	// only to populate with dummy data
	if($(this).attr('opi-page') == 5) {
		populate_paths(restore_paths);
	}
});

$("#btn-shutdown").click(function() {
	$(".page").addClass("hidden");
	$("#page_shutdown").removeClass("hidden");
});

function getQueryVariable(variable)
{
	// get a variable from the URL
	var query = window.location.search.substring(1);
	var vars = query.split("&");
	for (var i=0;i<vars.length;i++) {
	        var pair = vars[i].split("=");
	        if(pair[0] == variable){return pair[1];}
	}
	return(false);
}

function populate_paths(paths) {
	$("#restore_paths").empty();
	$("#restore_paths").append("<option disabled selected>Available sources</option>");	

	try {
		if(paths.remote.length > 0) {
			$("#restore_paths").append(
					"<optgroup label='-- OpenProducts remote server --'></optgroup>"
			)
			$.each(paths.remote,function(index,value) {
				$("#restore_paths").append(
					"<option value='"+value+"'>Backup from "+value.substring(value.lastIndexOf("/")+1,value.lastIndexOf("_"))+"</option>"
				);
			});
		}
	} catch(e){}

	try {
		if(paths.local.length > 0) {
			$("#restore_paths").append(
					"<optgroup label='-- Local (USB) --'></optgroup>"
			)
			$.each(paths.local,function(index,value) {
				$("#restore_paths").append(
					"<option value='"+value+"'>Backup from "+value.substring(value.lastIndexOf("/")+1,value.lastIndexOf("_"))+"</option>"
				);
			});

		}
	} catch(e){}
	
}


var pages = {
	0:"page_error",
	// 3:"page_knownunit_id",
	// 4:"page_knownunit_id",
	5:"page_restorebackup",
	6:"page_restoreinprogress",
	7:"page_user",
	10:"page_unlockpassword",
	13:"page_shutdownprogress",
	14:"page_rebootprogress",
	15:"page_postinit",
	17:"page_sderror",
	18:"page_opiname",
	19:"page_knownunit_id",
	20:"page_password",
	99:"page_initprogress", // Local state not used on server side
}

function setState(state) {

	if( ! pages.hasOwnProperty( state ) )
	{
		console.log("Unknown state! "+state);
		state = 0;
	}

	current_state = state;

	// remove possible error messages
	$("#validation_error_msg").text('');
	$("#validation_error").addClass("hidden");

	$(".page").addClass("hidden");

	for( var page in pages )
	{
		if( state == page ) 
		{
			$("#"+pages[page]).removeClass("hidden");
			$("#"+pages[page]).find("input, select").filter(':visible:first').focus();
			if( page != 99) {
				/* state 99 is show init in progress
				 * and is set prior to the sending of the form
				 * so it can not be allowed to reset the form */
				$.each($("form"),function() {
					if($(this).attr('id') != "pwdform") {
						// reset form to clear error markers.
						// do not reset the pwdform since that will reset the hidden (and required) unit_id field.
						$(this).get(0).reset();
					}
				});
			}
		}
	}

}

function redirect(url,timeout) {
	$("#spinner-bg").removeClass("hidden");
	setTimeout(function() {
		location.href = url;
	},timeout*1000);
}

function poll_restore()
{

	$.get("/status",function(data) {
		setState(data.state);
	})
	.fail(function() {
		console.log("Poll restore request failed");
	});

	if( current_state == 6 ) // doing restore
	{
		setTimeout( poll_restore, 5000 );
	}
	else if( current_state == 15 )
	{
		done("");
	}
}

function done(fqdn) {
	$.ajax({
		  type: "POST",
		  url: "/terminate",
		  contentType : "application/json",
		  data: '{"shutdown" : true}',
		})
		.done(function( result ) {
			if(result.status != true) {
				try {
					$("#validation_error_msg").text(result.errmsg);	
				} catch(err) {
				    console.log(err.message);
				}
				
			} else {
				//console.log("Redirecting");

				// is the unit accessed by OP's domain pointers?
				// could be "local." or IP also.
				console.log(domains);
				// is the access from the "local.devicename.domain.com" url?
				if(location.href.indexOf("local") > 0) {
					redirect("https://local."+fqdn,10);
					return true;
				} else {
					// do we have any of our domain in the url?
					for (i = 0; i < domains.length; i++) {
						if(location.href.indexOf(domains[i]) > 0) {
							redirect("https://"+fqdn,10);
							return true;
						}
					}
				}
				// something other in the url, just redirect to the new site on the same hostname
				redirect("/admin",10);
			}
		})
		.fail(function() {
			setState(1);
		});
	
}

function setHelp(type="") {
	$.each($('input[title]'), function() {
		if(helptext[$(this).attr("name")+"_"+type]) {
			$(this).attr("title", helptext[$(this).attr("name")+"_"+type]);
		} else if(helptext[$(this).attr("name")]) {
			$(this).attr("title", helptext[$(this).attr("name")]);
		}
	});

}
function getType() {
	//console.log("Trying to determine system type");
	systype = false;
	$.get("/gettype",function(data) {
		systype = data.type;
		if (data.type=="Armada") {
			$("span.typename").text("KEEP");
		} else {
			$("span.typename").text("OPI");
		}
		setHelp(systype);
	}, "json" )
	.fail(function() {
		console.log("Request 'type' failed");
	});
	return systype;
}

function getDomains() {
	console.log("Retreiving available domains");
	domains = false;
	selected = "";
	$.get("/getdomains",function(data) {
		domains = data.domains;
		for (i = 0; i < domains.length; i++) {
	  		if ( domains[i] ) {
	  		  	console.log("Append "+domains[i]+" to domains");
	  		  	if(data.domain == domains[i]) {
	  		  		selected = 'selected="selected"';
	  		  	}
	  		  	else {
	  		  		selected = "";
	  		  	}

	  		  	$("#select_domain").append('<option value="'+domains[i]+'" '+selected+'>'+domains[i]+'</option>');
			} 
		}
	}, "json" )
	.fail(function() {
		console.log("Request 'Domains' failed.");
	});
	return domains;
}


var opiname_check = false;
$("#opiname").keyup( function() {
	if(opiname_check) opiname_check.abort(); // abort any ongoing checks 
	opiname_check = $.ajax({
		url : "/checkname",
		data : JSON.stringify({ opiname : $("#opiname").val(), domain : $("#select_domain").val()}),
		contentType : "application/json",
		type : "POST",
	}).done(function(data) {
		if(data.available) {
			$("#opi_namestate").text("Name available");
			$("#opi_namestate").parent().addClass("has-success");
			$("#opi_namestate").parent().removeClass("has-error");
			$("#btnOpiname").removeAttr("disabled","disabled");
			console.log("NAME OK");
		} else {
			$("#opi_namestate").text("Name not available");
			$("#opi_namestate").parent().addClass("has-error");
			$("#opi_namestate").parent().removeClass("has-success");
			$("#btnOpiname").attr("disabled","disabled");
			console.log("NAME NOT OK");
		}
	});	
});

$("input").keypress(function(e) {
	if(e.which != 13) {
	$("#validation_error_msg").text('');
	$("#validation_error").addClass("hidden");
	}
});

$(document).ready( function() {
	var unit_id;

	type=getType();
	domains=getDomains();

	// fix margin if we are running in a small browser.
	if($(window).width() < 760) {
		margin = ($(window).width() - 400)/2; 
		$("#login").css("marginLeft",margin+"px");
	}

	$("input[type='text']").addClass("form-control");
	$("input[type='password']").addClass("form-control");
	$("button").addClass("btn").addClass("btn-primary");
	$(".page button").addClass("fullwidth");
	unit_id = getQueryVariable('unit_id');
	if(unit_id) {
		var re = new RegExp(/[\w\d\-]{36}/);
		if(re.test(unit_id)) {
			$("#unit_id").val(unit_id);
			$("#div_unit_id").addClass("hidden");
		}
	}	 
	
	if($( window ).width() < 805) {
		qtip_pos_my =  'top center';
		qtip_pos_at =	'center center';
		qtip_pos_adjust = { 
					y : 25,
					x : 25
				}
	} else {
		qtip_pos_my =  'left bottom';
		qtip_pos_at =	'top right';
		qtip_pos_adjust = { }
	}
	$('input[title]').qtip({
		show: 'focus',
		hide: 'blur',
		position : {
			my	: qtip_pos_my,
			at : qtip_pos_at,
			adjust : qtip_pos_adjust,
			container : $('#login')
		},
		style: {
        	classes: 'qtip-rounded qtip-shadow',
        	width : '225px'
		}
	});

	setHelp();

	$.validate( {
		modules : 'security',
		onModulesLoaded : function() {
			/*
			var optionalConfig = {
				fontSize: '10px',
				padding: '0px',
				bad : 'WEAK PASSWORD',
				weak : 'WEAK PASSWORD',
				good : 'FAIR PASSWORD',
				strong : 'STRONG PASSWORD',
			};
			*/
			var optionalConfig = {
				fontSize: '10px',
				padding: '0px',
				bad : '',
				weak : '',
				good : '',
				strong : '',
			};
			//$('input[name="masterpassword_confirmation"]').displayPasswordStrength(optionalConfig);
			//$('input[name="password_confirmation"]').displayPasswordStrength(optionalConfig);
		},
		onSuccess : function($form) {
			url = $form.find("button[type='submit']").attr('href');
			if( (url == "/init") || (url == "/reinit") ) {
				// trying to init, show init info to user
				setState(99);
			}
			// collect the form data while iterating over the inputs
			formdata = $form.find("input, select, button");
			var data = {};
			for (var i = 0, ii = formdata.length; i < ii; ++i) {
				var input = formdata[i];
				if (input.name) {
					if( input.type == "checkbox" ) {
						data[input.name] = input.checked;
					} else {
						data[input.name] = input.value;
					}
				}
			}
			if(button = $form.children('button')) {
				data[button.attr('name')] = button.val(); 
			}
			$("#spinner-bg").removeClass("hidden");
			$.ajax({
				type: "POST",
				url: url,
				contentType : "application/json",
				data: JSON.stringify(data),
			})
			.done(function( result ) {
				if(result.status != true) {
					$("#validation_error").removeClass("hidden");
					try {
						$("#validation_error_msg").text(result.errmsg);
						setState(result.state);
					} catch(err) {
						$("#validation_error_msg").text(err.message);
						console.log(err.message);
					}
						
				} else {
					// clear opiname input box messages
					$("#opi_namestate").text("");
					$("#opi_namestate").parent().removeClass("has-success");
					$("#opi_namestate").parent().removeClass("has-error");
					$("#btnOpiname").removeAttr("disabled","disabled");
					// set the opiname variable before the clearing all fields
					// done by set state
					fqdn = $("#opiname").val()+"."+$("#select_domain").val();
					setState(result.state);
					if(result.state == 5) {
						// make paths globally available
						var paths = {local:result.local, remote:result.remote};
						populate_paths(paths);
					}

					if( result.state == 6 ) // Restore in progress
					{
						poll_restore();
					}

					if(result.url) {
							try {
								redirect(result.url,result.timeout);
							} catch(err) {
								setState(1);
								console.log(err.message);
							}
					} else {
						if(result.state == 15 ) {
							// this will send the "terminate" signal to opi-control
							// then redirect to "/admin"
							done(fqdn);
						}
					}	
				}
				})
			.fail(function() {
				setState(1);
			})
			.always(function(result){
				if(!result.url) {
					$("#spinner-bg").addClass("hidden");
				}
			});

			return false;
		},
		onError : function($form) {
			console.log("Validation Failed");
			return false;
		}

	});

	$.get("/status",function(data) {
		//console.log(data);
		setState(data.state);
	})
	.fail(function() {
		setState(1);	
		console.log("request failed");
	});
	
});
</script>
</body>
</html>
